<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>演讲分析</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(to right, #1a2980, #26d0ce);
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin: 0;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-top: 8px;
        }
        
        .header .info {
            text-align: right;
        }
        
        .header .info div {
            margin-top: 5px;
            font-size: 1.1rem;
        }
        
        .nav {
            background: #f8f9fa;
            padding: 15px 40px;
            display: flex;
            gap: 25px;
            border-bottom: 1px solid #e0e0e0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav a {
            text-decoration: none;
            color: #2c3e50;
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 50px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .nav a:hover, .nav a.active {
            background: #1a2980;
            color: white;
        }
        
        .content {
            padding: 30px 40px;
        }
        
        .chart-section {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .chart-container {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            border: 1px solid #eaeaea;
            display: flex;
            flex-direction: column;

        }
        .chart-container canvas {
            width: 100% !important;
            height: 400px !important;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.4rem;
            color: #1a2980;
            font-weight: 600;
        }
        
        .chart-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            background: #eef2f7;
            color: #1a2980;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            background: #1a2980;
            color: white;
        }
        
        .chart {
            width: 100%;
            height: 400px;
            overflow: hidden;
        }


        
        .stats-section {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top: 4px solid #1a2980;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a2980;
            margin: 10px 0;
        }
        
        .stat-card .label {
            font-size: 1.1rem;
            color: #666;
        }
        
        .footer {
            text-align: center;
            padding: 25px;
            color: #666;
            border-top: 1px solid #eee;
            font-size: 0.95rem;
        }
        
        .ranking-table {
            width: 100%;
            margin-top: 30px;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }


        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #1a2980;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background: #f8fafc;
        }
        
        tr:hover {
            background: #eef7ff;
        }
        
        .medal {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 10px;
            font-weight: bold;
            color: white;
        }
        
        .gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
        .silver { background: linear-gradient(135deg, #C0C0C0, #A9A9A9); }
        .bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); }
        
        .highlight {
            background-color: #fffde7 !important;
            font-weight: 600;
        }
        
        .progress-container {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(to right, #1a2980, #26d0ce);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header .info {
                text-align: center;
                margin-top: 15px;
            }

            .nav {
                justify-content: center;
            }

            .chart-section {
                flex-direction: column;
            }

            .chart {
                height: 350px;
            }

        }


        .chat-container {
            width: 100%;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }
        .chat-messages {
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
            background-color: #f8f9fa;
        }
        .message-sender {
            font-weight: normal;
            font-size: 12px;
            color: #666666;
            margin-bottom: 5px;
            text-align: left;
        }
        .message-sent {
            background-color: #28a745;
            color: white;
            text-align: right;
            margin-left: 50px;
        }
        .message-received {
            background-color: #f1f1f1;
            color: #333;
            text-align: left;
            margin-right: 50px;
        }
        .message {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            max-width: 100%;
            word-wrap: break-word;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>演讲分析</h1>
            </div>

        </div>
      
        
        <div class="content">
            <div class="stats-section">
                <div class="stat-card">
                    <i class="fas fa-users fa-2x"></i>
                    <div class="value">48</div>
                    <div class="label">听众总人数</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-line fa-2x"></i>
                    <div class="value">86.5</div>
                    <div class="label">平均正确率</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: 86.5%"></div>
                    </div>
                </div>

            </div>
            
            <div class="chart-section">
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">成绩排名柱状图</div>

                    </div>
                    <div id="rankingChart" class="chart"></div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">答题正确数分布</div>

                    </div>
                    <canvas id="scoreDistributionChart"></canvas>
                </div>
            </div>

            <div class="main-section">
                <!-- 左侧：成绩排名表 -->
                <div class="chart-container" style="flex: 1;">
                    <div class="chart-header">
                        <div class="chart-title">班级成绩排名表</div>
                    </div>
                    <div class="ranking-table">
                        <table>
                            <thead>
                            <tr>
                                <th>排名</th>
                                <th>姓名</th>
                                <th>成绩</th>
                                <th>答题正确数</th>
                            </tr>
                            </thead>
                            <tbody id="rankingTableBody">
                            <!-- Table content will be generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="chat-container" style="margin-top:20px;">
                    <div class="chat-header">
                        <h2>听众反馈</h2>
                    </div>


                    <div class="chat-messages" id="messages">
                        <div class="message">系统初始化中...</div>
                    </div>

                </div>
            </div>
        </div>
        
        <!-- <div class="footer">
            <p>© 2024 南京理工大学人工智能学院 | 数据更新时间: <span id="updateTime">2025-07-23 10:30:45</span></p>
            <p>系统开发: 陆建峰 | 指导老师: 王教授</p>
        </div> -->
    </div>

    <script>
        const params = new URLSearchParams(location.search);
        const speechID = params.get('SpeechID');


        //-//==----------------------------------------------------------------------------
        const messagesContainer = document.getElementById('messages');

        let stompClient = null;
        let connected = false;

        // 获取当前页面的 URL

        //session
        //const storedListenerInfo = JSON.parse(localStorage.getItem("listenerInfo"));

        // 获取 URL 中的 ListenerID 和 SpeechID 参数
        const listenerID = 0;


        const endpointUrl = 'http://localhost:8081/listener/tofeedback';

        // function displayMessage(message, isSent) {
        //     const messageDiv = document.createElement('div');
        //     messageDiv.className = `message ${isSent ? 'message-sent' : 'message-received'}`;
        //     messageDiv.textContent = message;
        //     messagesContainer.appendChild(messageDiv);
        //     messagesContainer.scrollTop = messagesContainer.scrollHeight;
        // }
        function displayMessage(message, isSent) {
            const messageDiv = document.createElement('div');

            // 根据消息的 listenerID 与当前 listenerID 比较，决定消息显示在左侧还是右侧
            const currentListenerID = parseInt(listenerID); // 假设当前用户的 listenerID 是通过 URL 获取的

            if (parseInt(message.listenerID) === currentListenerID) {
                // 当前用户的消息，显示在右侧
                messageDiv.className = 'message message-sent';
            } else {
                // 其他用户的消息，显示在左侧
                messageDiv.className = 'message message-received';
            }

            // 判断消息是否是状态消息
            if (typeof message === 'string') {
                // 如果是字符串消息，创建一个简化的消息对象
                const statusMessage = {
                    listenerID: null, // 状态消息没有实际的 listenerID
                    speechID: null,   // 状态消息没有实际的 speechID
                    fcontent: message // 纯文本内容
                };

                // 直接显示状态消息
                const messageContent = document.createElement('div');
                const messageTextDiv = document.createElement('span');
                messageTextDiv.className = 'message-text';
                messageTextDiv.textContent = statusMessage.fcontent;

                messageContent.appendChild(messageTextDiv);
                messageDiv.appendChild(messageContent);
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else {
                // 处理正常的消息
                fetch(`http://localhost:8081/users/listener/${message.listenerID}`)
                    .then(response => response.json())
                    .then(listenerInfo => {
                        const messageContent = document.createElement('div');

                        // 创建显示用户名的部分
                        const senderNameDiv = document.createElement('div');
                        senderNameDiv.className = 'message-sender';
                        senderNameDiv.textContent = listenerInfo.anonymous ? "匿名" : listenerInfo.uname;

                        // 创建显示消息内容的部分
                        const messageTextDiv = document.createElement('span');
                        messageTextDiv.className = 'message-text';
                        messageTextDiv.textContent = message.fcontent;

                        // 将用户名部分放到消息的顶部
                        messageDiv.appendChild(senderNameDiv);
                        messageContent.appendChild(messageTextDiv);
                        messageDiv.appendChild(messageContent);
                        messagesContainer.appendChild(messageDiv);

                        // 滚动到底部显示最新的消息
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    })
                    .catch(err => {
                        console.error('获取用户信息失败', err);
                        const messageContent = document.createElement('div');
                        const messageTextDiv = document.createElement('span');
                        messageTextDiv.className = 'message-text';
                        messageTextDiv.textContent = message.fcontent;
                        messageContent.appendChild(messageTextDiv);
                        messageDiv.appendChild(messageContent);
                        messagesContainer.appendChild(messageDiv);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    });
            }
        }






        // 加载历史消息
        function loadHistory() {
            fetch(`http://localhost:8081/feedback/history?speechID=${speechID}`)
                .then(response => response.json())
                .then(messages => {
                    messages.forEach(msg => {
                        console.log(messages);  // 查看返回的数据
                        if (messages.length === 0) {
                            console.log('没有历史消息');
                        }
                        displayMessage(msg, false);
                    });
                })
                .catch(err => console.error('加载历史消息失败', err));
        }

        function connect() {
            if (connected) return;

            try {
                const socket = new SockJS(endpointUrl);
                stompClient = Stomp.over(socket);
                stompClient.connect({}, function() {
                    connected = true;
                    displayMessage('已连接到聊天室', false);

                    // 订阅消息，接收消息并过滤不属于自己的消息
                    stompClient.subscribe(`/topic/chat/${speechID}`, function(message) {
                        const receivedMsg = JSON.parse(message.body);

                        // 正确过滤：只显示其他人发送的消息
                        if (parseInt(receivedMsg.listenerID) !== parseInt(listenerID)) {
                            displayMessage(receivedMsg, false); // 显示为接收消息
                        }
                    });

                    loadHistory();  // 连接后加载历史消息

                    // 现在设置 onDisconnect 处理程序
                    stompClient.onDisconnect = function() {
                        setTimeout(connect, 5000); // 5秒后重连
                    };

                });
            } catch (error) {
                console.log(speechID);
                console.error('连接失败，错误详情:', error); // 记录错误详情
                displayMessage('连接失败，请重试', false);
            }
        }



        //-------------------------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', function() {

            connect();


            // 生成随机学生数据
            function generateStudentData(count) {
                const classes = ['一班', '二班', '三班'];
                const surnames = ['张', '李', '王', '赵', '刘', '陈', '杨', '周', '黄', '吴', '郑', '孙', '马', '朱', '胡', '林', '高'];
                const names = ['明', '华', '芳', '强', '伟', '晓', '帆', '婷', '洋', '浩', '莉', '进', '琳', '超', '杰', '涛', '敏', '翔', '旭', '宁', '宇'];
                
                const students = [];
                for (let i = 1; i <= count; i++) {
                    const surname = surnames[Math.floor(Math.random() * surnames.length)];
                    const name = names[Math.floor(Math.random() * names.length)];
                    const fullName = surname + name;
                    const score = Math.floor(Math.random() * 21) + 80; // 80-100
                    const correctAnswers = Math.floor(Math.random() * 6); // 0-5
                    const cls = classes[Math.floor(Math.random() * classes.length)];
                    
                    students.push({
                        id: `2024${String(i).padStart(4, '0')}`,
                        name: fullName,
                        score: score,
                        correctAnswers: correctAnswers,
                        class: cls,
                        rank: i
                    });
                }
                
                // 按成绩从高到低排序
                students.sort((a, b) => b.score - a.score);
                
                // 分配排名
                students.forEach((student, index) => {
                    student.rank = index + 1;
                });
                
                return students;
            }
            
            // 渲染排名表格
            function renderRankingTable(students) {
                const tableBody = document.getElementById('rankingTableBody');
                tableBody.innerHTML = '';
                
                students.forEach(student => {
                    const row = document.createElement('tr');
                    
                    // 添加奖牌样式
                    let rankCell = '';
                    if (student.rank === 1) {
                        rankCell = `<td><span class="medal gold">${student.rank}</span></td>`;
                    } else if (student.rank === 2) {
                        rankCell = `<td><span class="medal silver">${student.rank}</span></td>`;
                    } else if (student.rank === 3) {
                        rankCell = `<td><span class="medal bronze">${student.rank}</span></td>`;
                    } else {
                        rankCell = `<td>${student.rank}</td>`;
                    }
                    
                    row.innerHTML = `
                        ${rankCell}

                        <td>${student.name}</td>
                        <td>${student.score}</td>
                        <td>${student.correctAnswers}</td>

                    `;
                    tableBody.appendChild(row);
                });
            }
            
            // 生成学生数据
            const studentData = generateStudentData(48);
            renderRankingTable(studentData);
            
            // 初始化饼图
            const ctx = document.getElementById('scoreDistributionChart').getContext('2d');
            
            // 计算答题正确数分布
            const answerDistribution = [0, 0, 0, 0, 0, 0];
            studentData.forEach(student => {
                if (student.correctAnswers >= 0 && student.correctAnswers <= 5) {
                    answerDistribution[student.correctAnswers]++;
                }
            });
            
            const scoreDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['0题', '1题', '2题', '3题', '4题', '5题'],
                    datasets: [{
                        data: answerDistribution,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: '答题正确数分布',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed}人 (${Math.round(context.parsed/48*100)}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 提取排序后的姓名和成绩
            const sortedNames = studentData.map(student => student.name);
            const sortedScores = studentData.map(student => student.score);
            
            // 初始化柱状图
            const chartDom = document.getElementById('rankingChart');
            const myChart = echarts.init(chartDom);
            
            // 计算初始显示的数据量（大约显示15个）
            const initialShowCount = 15;
            const endPercent = Math.min(100, (initialShowCount / sortedNames.length) * 100);
            
            const option = {
                title: {
                    text: '学生成绩排名',
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        const data = params[0];
                        const student = studentData[data.dataIndex];
                        return `
                            <b>${student.name}</b><br/>
                            排名: ${student.rank}<br/>
                            成绩: ${student.score}分<br/>
                            学号: ${student.id}<br/>
                            班级: ${student.class}
                        `;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value',
                    name: '成绩',
                    nameLocation: 'middle',
                    nameGap: 30,
                    axisLabel: {
                        formatter: '{value} 分'
                    },
                    splitLine: {
                        lineStyle: {
                            type: 'dashed'
                        }
                    }
                },
                yAxis: {
                    type: 'category',
                    data: sortedNames,
                    axisLabel: {
                        interval: 0,
                        rotate: 0,
                        fontSize: 12
                    },
                    axisLine: {
                        show: true
                    }
                },
                series: [
                    {
                        name: '成绩',
                        type: 'bar',
                        data: sortedScores,
                        showBackground: true,
                        backgroundStyle: {
                            color: 'rgba(180, 180, 180, 0.2)'
                        },
                        itemStyle: {
                            color: function(params) {
                                // 根据排名设置不同颜色
                                const rank = params.dataIndex + 1;
                                if (rank === 1) return new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    {offset: 0, color: '#FFD700'},
                                    {offset: 1, color: '#FFA500'}
                                ]);
                                if (rank === 2) return new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    {offset: 0, color: '#C0C0C0'},
                                    {offset: 1, color: '#A9A9A9'}
                                ]);
                                if (rank === 3) return new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    {offset: 0, color: '#CD7F32'},
                                    {offset: 1, color: '#8B4513'}
                                ]);
                                return new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    {offset: 0, color: '#1a2980'},
                                    {offset: 1, color: '#26d0ce'}
                                ]);
                            },
                            borderRadius: [0, 5, 5, 0]
                        },
                        label: {
                            show: true,
                            position: 'right',
                            formatter: '{c}分'
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'slider',
                        orient: 'vertical',
                        yAxisIndex: [0],
                        right: 10,
                        width: 12,
                        start: 0,
                        end: endPercent,
                        handleSize: 8,
                        zoomLock: true,
                        brushSelect: false
                    },
                    {
                        type: 'inside',
                        yAxisIndex: [0],
                        zoomLock: true
                    }
                ]
            };
            
            myChart.setOption(option);
            

            


            

            
            // 响应窗口变化
            window.addEventListener('resize', function() {
                myChart.resize();
                scoreDistributionChart.resize();
            });





        });




    </script>
</body>
</html>